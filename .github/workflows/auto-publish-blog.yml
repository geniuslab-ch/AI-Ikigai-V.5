name: Auto-Publish Blog Article

on:
  schedule:
    # Every Friday at 10:00 UTC (11:00 UTC+1 Swiss time)
    - cron: '0 10 * * 5'
  workflow_dispatch: # Allow manual trigger for testing

jobs:
  publish-article:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Check for articles to publish
        id: check_article
        run: |
          node -e "
          const fs = require('fs');
          const articlesData = JSON.parse(fs.readFileSync('blog/data/articles.json', 'utf8'));
          const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
          
          // Find articles scheduled for today or earlier that are still 'scheduled'
          const toPublish = articlesData.articles.filter(a => 
            a.status === 'scheduled' && a.publishDate <= today
          );
          
          if (toPublish.length > 0) {
            console.log('ARTICLES_TO_PUBLISH=' + toPublish.length);
            console.log('FIRST_ARTICLE_TITLE=' + toPublish[0].title);
            console.log('FIRST_ARTICLE_ID=' + toPublish[0].id);
            toPublish.forEach(a => {
              a.status = 'published';
            });
            fs.writeFileSync('blog/data/articles.json', JSON.stringify(articlesData, null, 2));
            process.exit(0); // Success
          } else {
            console.log('No articles to publish today');
            process.exit(1); // Nothing to publish
          }
          "
        continue-on-error: true
      
      - name: Commit and push changes
        if: steps.check_article.outcome == 'success'
        run: |
          git config user.name "Blog Auto-Publisher"
          git config user.email "bot@ai-ikigai.com"
          git add blog/data/articles.json
          git commit -m "Auto-publish: Article(s) for $(date +%Y-%m-%d)
          
          Published articles scheduled for today or earlier.
          Triggered by GitHub Actions workflow." || exit 0
          git push
      
      - name: Create success summary
        if: steps.check_article.outcome == 'success'
        run: |
          echo "✅ Article(s) successfully published!" >> $GITHUB_STEP_SUMMARY
          echo "Date: $(date)" >> $GITHUB_STEP_SUMMARY
      
      - name: No articles to publish
        if: steps.check_article.outcome == 'failure'
        run: |
          echo "ℹ️ No articles scheduled for publication today" >> $GITHUB_STEP_SUMMARY
          echo "Date: $(date)" >> $GITHUB_STEP_SUMMARY
